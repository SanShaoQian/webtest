name: CI/CD

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compile check
        run: |
          python -m py_compile app/__init__.py app/main.py app/virustotal.py app/genai.py run.py

  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH key
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf "%s" "$EC2_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add EC2 host key
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_PORT: ${{ secrets.EC2_PORT }}
          EC2_KNOWN_HOSTS: ${{ secrets.EC2_KNOWN_HOSTS }}
        run: |
          PORT="${EC2_PORT:-22}"
          if [ -n "${EC2_KNOWN_HOSTS}" ]; then
            printf "%s\n" "${EC2_KNOWN_HOSTS}" >> ~/.ssh/known_hosts
            exit 0
          fi
          ssh-keyscan -T 10 -p "$PORT" -H "$EC2_HOST" >> ~/.ssh/known_hosts
          test -s ~/.ssh/known_hosts

      - name: Sync repo to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_PORT: ${{ secrets.EC2_PORT }}
          APP_DIR: ${{ secrets.EC2_APP_DIR }}
        run: |
          PORT="${EC2_PORT:-22}"
          TARGET_DIR="${APP_DIR:-/home/ubuntu/webtest}"
          rsync -az --delete \
            --exclude ".git/" \
            --exclude ".venv/" \
            --exclude ".env" \
            --exclude "__pycache__/" \
            --exclude "*.pyc" \
            -e "ssh -p $PORT -i ~/.ssh/id_ed25519" \
            ./ "${EC2_USER}@${EC2_HOST}:${TARGET_DIR}/"

      - name: Restart application on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_PORT: ${{ secrets.EC2_PORT }}
          APP_DIR: ${{ secrets.EC2_APP_DIR }}
        run: |
          PORT="${EC2_PORT:-22}"
          TARGET_DIR="${APP_DIR:-/home/ubuntu/webtest}"
          ssh -T -p "$PORT" -i ~/.ssh/id_ed25519 -o BatchMode=yes "${EC2_USER}@${EC2_HOST}" "bash -s" <<EOF
          set -euo pipefail
          cd "${TARGET_DIR}"
          if [ ! -f .env ]; then
            echo "Missing ${TARGET_DIR}/.env on EC2. Create it once with VT/GEMINI keys."
            exit 1
          fi
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          python -m py_compile app/__init__.py app/main.py app/virustotal.py app/genai.py run.py
          sudo cp deploy/webtest.service /etc/systemd/system/webtest.service
          sudo systemctl daemon-reload
          sudo systemctl reset-failed webtest || true
          if ! sudo systemctl restart webtest; then
            sudo systemctl --no-pager --full status webtest || true
            sudo journalctl -u webtest -n 200 --no-pager || true
            exit 1
          fi
          sudo systemctl restart nginx
          curl -fsS http://127.0.0.1:8000/health >/dev/null
          curl -fsS http://127.0.0.1/health >/dev/null
          sudo systemctl --no-pager --full status webtest
          EOF
